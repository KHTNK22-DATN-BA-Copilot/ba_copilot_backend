<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>AI Generator â€“ Step by Step WS</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <style>
    body {
      font-family: Consolas, monospace;
      background: #0f172a;
      color: #e5e7eb;
      padding: 20px;
    }

    .container {
      max-width: 1300px;
      margin: auto;
      display: grid;
      grid-template-columns: 380px 1fr;
      gap: 20px;
    }

    .card {
      background: #020617;
      border-radius: 8px;
      padding: 16px;
      border: 1px solid #1e293b;
      margin-bottom: 20px;
    }

    h2, h3 {
      margin-top: 0;
      color: #38bdf8;
    }

    label {
      display: block;
      margin-top: 10px;
      font-size: 13px;
      color: #94a3b8;
    }

    input, textarea {
      width: 100%;
      padding: 8px;
      margin-top: 5px;
      background: #020617;
      color: #e5e7eb;
      border: 1px solid #1e293b;
      border-radius: 4px;
    }

    button {
      width: 100%;
      padding: 10px;
      margin-top: 12px;
      font-weight: bold;
      border-radius: 4px;
      cursor: pointer;
      border: none;
    }

    .btn-start { background: #22c55e; color: black; }
    .btn-step { background: #38bdf8; color: black; }

    .doc-group {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
      gap: 6px;
      margin-top: 8px;
    }

    .doc-item {
      background: #020617;
      border: 1px solid #1e293b;
      padding: 6px 8px;
      border-radius: 6px;
      font-size: 13px;
    }

    #log, #output {
      background: black;
      padding: 12px;
      border-radius: 4px;
      font-size: 13px;
      overflow-y: auto;
    }

    #log { height: 260px; }
    #output { height: 360px; white-space: pre-wrap; }

    .log { margin-bottom: 6px; }
    .log-info { color: #eab308; }
    .log-ok { color: #22c55e; }
    .log-error { color: #ef4444; }
  </style>
</head>

<body>

<div class="container">

  <!-- LEFT -->
  <div>

    <div class="card">
      <h2>Connection</h2>

      <label>Base WS URL</label>
      <input id="wsBase" value="ws://localhost:8010" />

      <label>Project ID</label>
      <input id="projectId" value="1" />

      <label>JWT Token</label>
      <input id="token" placeholder="Paste JWT token" />

      <label>Project Name</label>
      <input id="projectName" value="AI Platform" />

      <label>Description</label>
      <textarea id="description" rows="3">AI powered SaaS platform</textarea>
    </div>

    <div class="card">
      <h3>Planning Documents</h3>
      <div id="planningDocs" class="doc-group"></div>
      <button class="btn-step" onclick="runPlanning()">Generate Planning</button>
    </div>

    <div class="card">
      <h3>Design Documents</h3>
      <div id="designDocs" class="doc-group"></div>
      <button class="btn-step" onclick="runDesign()">Generate Design</button>
    </div>

  </div>

  <!-- RIGHT -->
  <div>
    <div class="card">
      <h3>Realtime Logs</h3>
      <div id="log"></div>
    </div>

    <div class="card">
      <h3>Generated Output</h3>
      <div id="output"></div>
    </div>
  </div>

</div>

<script>
/* ================= DOCUMENT LIST ================= */
const PLANNING_DOCS = [
  "stakeholder-register",
  "high-level-requirements",
  "business-case",
  "product-roadmap",
]

const DESIGN_DOCS = [
  "hld-arch",
  "hld-cloud",
  "lld-api",
  "uiux-wireframe",
]

function render(container, docs) {
  const c = document.getElementById(container)
  docs.forEach(d => {
    const div = document.createElement("div")
    div.className = "doc-item"
    div.innerHTML = `
      <label>
        <input type="checkbox" value="${d}" /> ${d}
      </label>
    `
    c.appendChild(div)
  })
}

render("planningDocs", PLANNING_DOCS)
render("designDocs", DESIGN_DOCS)

/* ================= LOG ================= */
const logBox = document.getElementById("log")
function log(msg, type="info") {
  const div = document.createElement("div")
  div.className = `log log-${type}`
  div.innerText = `[${new Date().toLocaleTimeString()}] ${msg}`
  logBox.appendChild(div)
  logBox.scrollTop = logBox.scrollHeight
}

/* ================= OUTPUT ================= */
const outputBox = document.getElementById("output")
function showResult(step, doc, data) {
  outputBox.textContent +=
    `\n===== ${step.toUpperCase()} :: ${doc} =====\n` +
    JSON.stringify(data, null, 2) + "\n"
  outputBox.scrollTop = outputBox.scrollHeight
}

/* ================= WS CORE ================= */
function getSelected(container) {
  return Array.from(
    document.getElementById(container).querySelectorAll("input:checked")
  ).map(i => ({ type: i.value }))
}

function openStepWS(step, documents, onDone) {
  const base = wsBase.value
  const pid = projectId.value
  const token = document.getElementById("token").value

  const ws = new WebSocket(
    `${base}/api/v1/ws/projects/${pid}/${step}?token=${token}`
  )

  ws.onopen = () => {
    log(`WS ${step} connected`, "ok")
    ws.send(JSON.stringify({
      project_name: projectName.value,
      description: description.value,
      documents,
    }))
  }

  ws.onmessage = e => {
    const data = JSON.parse(e.data)

    if (data.type === "doc_start") {
      log(`[${step}] Start ${data.doc_type}`)
    }

    if (data.type === "doc_completed") {
      log(`[${step}] Done ${data.doc_type}`, "ok")
      showResult(step, data.doc_type, data.data)
    }

    if (data.type === "step_finished") {
      log(`[${step}] STEP FINISHED`, "ok")
      ws.close()
    }
  }

  ws.onclose = () => {
    log(`WS ${step} closed`, "info")
    onDone?.()
  }
}

/* ================= FLOW CONTROL ================= */
let planningDone = false

function runPlanning() {
  const docs = getSelected("planningDocs")
  if (!docs.length) return alert("Select planning docs")

  openStepWS("planning", docs, () => {
    planningDone = true
    log("Planning completed. Choose Design docs.", "ok")
  })
}

function runDesign() {
  if (!planningDone) return alert("Finish Planning first")

  const docs = getSelected("designDocs")
  if (!docs.length) return alert("Select design docs")

  openStepWS("design", docs)
}
</script>

</body>
</html>
